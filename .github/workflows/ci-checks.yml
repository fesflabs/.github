name: CI Centralizado (Build/Test)

on:
  workflow_call:
    inputs:
      project_type:
        description: "Tipo de projeto: 'backend' ou 'frontend'"
        required: true
        type: string
      service_name:
        description: "Nome do serviço no docker-compose (ex: python-back, front_end)"
        required: true
        type: string
      working_directory:
        description: "Caminho da pasta onde está o docker-compose.yml (ex: docker/develop)"
        required: false
        default: "."
        type: string
      runner_labels:
        description: "Labels do runner (JSON array)"
        required: false
        type: string
        default: '["self-hosted", "ci", "ephemeral"]'
    secrets:
      ENV_FILE_CONTENT:
        description: 'Conteúdo completo do .env'
        required: true

jobs:
  build-test:
    name: Build & Test
    runs-on: ${{ fromJSON(inputs.runner_labels) }}
    
    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      # --- SETUP DE AMBIENTE (Node/PNPM apenas se for frontend) ---
      - name: Configuração Node.js
        if: ${{ inputs.project_type == 'frontend' }}
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Instalação do pnpm
        if: ${{ inputs.project_type == 'frontend' }}
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Obter diretório de cache do pnpm
        if: ${{ inputs.project_type == 'frontend' }}
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Configurar cache do Runner
        if: ${{ inputs.project_type == 'frontend' }}
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-v1-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-v1-

      - name: Instalar dependências (Frozen Lockfile)
        if: ${{ inputs.project_type == 'frontend' }}
        run: pnpm install --frozen-lockfile

      # --- PREPARAÇÃO DO BUILD ---
      - name: Criar .env para build
        working-directory: ${{ inputs.working_directory }}
        run: |
          if [ "${{ inputs.project_type }}" == "frontend" ]; then
            echo "Criando .env específico para Frontend..."
            # Filtra apenas variáveis públicas necessárias para o build do Next.js
            echo "${{ secrets.ENV_FILE_CONTENT }}" | grep "NEXT_PUBLIC_" > .env || true
          else
            echo "Criando .env genérico para Backend..."
            echo "DUMMY_VAR=DUMMY_VALUE" > .env
          fi

      - name: Build Docker (BuildKit)
        working-directory: ${{ inputs.working_directory }}
        env:
          DOCKER_BUILDKIT: 1
        run: docker compose build --pull ${{ inputs.service_name }}

      - name: Limpar imagens Docker não utilizadas
        if: always()
        run: docker image prune -f
