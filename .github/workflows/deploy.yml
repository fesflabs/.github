name: CD Centralizado (Deploy)

on:
  workflow_call:
    inputs:
      service_name:
        description: "Nome do serviÃ§o no docker-compose"
        required: true
        type: string
      working_directory:
        description: "DiretÃ³rio do docker-compose"
        required: false
        default: "."
        type: string
      runner_labels:
        description: "Labels do runner de deploy"
        required: true
        type: string
      image_full_tag:
        description: "Imagem completa para deploy (ex: 192.168.../back:sha)"
        required: true
        type: string
    secrets:
      ENV_FILE_CONTENT:
        required: true
      REGISTRY_USERNAME:
        required: true
      REGISTRY_PASSWORD:
        required: true

jobs:
  check-approvals:
    name: Verificar AprovaÃ§Ã£o
    runs-on: ubuntu-latest
    steps:
      - name: Verificar Reviews
        uses: actions/github-script@v7
        with:
          script: |
            if (!context.payload.pull_request) return;
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            const approved = reviews.some(r => r.state === "APPROVED");
            if (!approved) core.setFailed("âŒ PR sem aprovaÃ§Ã£o. Deploy bloqueado.");

  deploy:
    name: Deploy
    needs: check-approvals
    runs-on: ${{ fromJSON(inputs.runner_labels) }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- LOGIN NECESSÃRIO PARA PULL ---
      - name: Login no Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.ORG_REGISTRY_URL }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Gerar .env
        working-directory: ${{ inputs.working_directory }}
        run: echo "${{ secrets.ENV_FILE_CONTENT }}" > .env

      # --- DEPLOY ---
      - name: Atualizar ServiÃ§o
        working-directory: ${{ inputs.working_directory }}
        env:
          # Injeta a variÃ¡vel IMAGE_TAG para o docker-compose usar
          IMAGE_TAG: ${{ inputs.image_full_tag }}
        run: |
          echo "ðŸš€ Baixando imagem: $IMAGE_TAG"
          docker compose pull ${{ inputs.service_name }}
          
          echo "ðŸš€ Recriando container..."
          docker compose up -d --force-recreate --no-deps ${{ inputs.service_name }}

      - name: Limpeza
        if: always()
        run: docker image prune -f