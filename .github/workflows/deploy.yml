name: CD Centralizado (Deploy)

on:
  workflow_call:
    inputs:
      service_name:
        description: "Nome do serviÃ§o a ser deployado"
        required: true
        type: string
      working_directory:
        description: "Caminho da pasta onde estÃ¡ o docker-compose.yml"
        required: false
        default: "."
        type: string
      runner_labels:
        description: "Labels do runner de deploy (JSON array)"
        required: true
        type: string
    secrets:
      ENV_FILE_CONTENT:
        description: 'ConteÃºdo do .env para produÃ§Ã£o/develop'
        required: true

jobs:
  check-approvals:
    name: Verificar AprovaÃ§Ã£o do PR
    runs-on: ubuntu-latest
    steps:
      - name: Verificar Status do Review
        uses: actions/github-script@v7
        with:
          script: |
            if (!context.payload.pull_request) {
              console.log("NÃ£o Ã© um PR, pulando verificaÃ§Ã£o.");
              return;
            }
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            const approved = reviews.some(r => r.state === "APPROVED");
            if (!approved) {
              core.setFailed("âŒ O PR foi mergeado sem aprovaÃ§Ã£o. Bloqueando deploy.");
            } else {
              console.log("âœ… PR aprovado. Prosseguindo.");
            }

  deploy:
    name: Deploy CirÃºrgico
    needs: check-approvals
    runs-on: ${{ fromJSON(inputs.runner_labels) }}
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: Criar arquivo .env
        working-directory: ${{ inputs.working_directory }}
        run: |
          echo "Gerando .env em ${{ inputs.working_directory }}..."
          echo "${{ secrets.ENV_FILE_CONTENT }}" > .env

      - name: Docker Compose Up (No-Deps)
        working-directory: ${{ inputs.working_directory }}
        run: |
          echo "ðŸš€ Atualizando serviÃ§o: ${{ inputs.service_name }}"
          # --force-recreate: Garante que o container seja recriado com a nova imagem
          # --no-deps: NÃ£o reinicia banco de dados ou outros serviÃ§os linkados
          docker compose up -d --force-recreate --no-deps ${{ inputs.service_name }}

      - name: Limpeza PÃ³s-Deploy
        if: always()
        run: docker image prune -f
